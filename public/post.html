<!-- post.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>글 보기</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: #f9fafb;
      color: #111827;
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: 1.5rem auto;
      padding: 0 1rem 3rem;
    }
    nav.navbar {
      background-color: #2563eb;
      padding: 0.5rem 1rem;
    }
    nav.navbar a {
      color: #fff;
      margin-right: 1rem;
      text-decoration: none;
      font-weight: 600;
    }
    nav.navbar a:hover {
      text-decoration: underline;
    }
    article.card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    article.card h2 {
      margin-top: 0;
      color: #2563eb;
    }
    article.card p {
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .btn {
      background-color: #2563eb;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1.2rem;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    .btn:hover {
      background-color: #1d4ed8;
    }
    .btn-outline {
      background-color: transparent;
      color: #2563eb;
      border: 2px solid #2563eb;
    }
    .btn-outline:hover {
      background-color: #2563eb;
      color: #fff;
    }
    .btn-outline[style*="color:red"] {
      border-color: red;
      color: red;
    }
    .btn-outline[style*="color:red"]:hover {
      background-color: red;
      color: #fff;
    }
    .comment {
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .comment h3 {
      margin-top: 0;
      color: #2563eb;
    }
    .comment-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
      border-top: 1px solid #e5e7eb;
      padding-top: 1rem;
    }
    .comment-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
      word-break: break-word;
    }
    textarea.textarea {
      width: 100%;
      min-height: 60px;
      border-radius: 12px;
      border: 1.5px solid #d1d5db;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      resize: vertical;
      font-family: inherit;
    }
    textarea.textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 5px rgba(37, 99, 235, 0.5);
    }
    @media (max-width: 600px) {
      .container {
        padding: 0 1rem 1.5rem;
      }
      nav.navbar a {
        font-size: 0.9rem;
      }
      .btn {
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
      }
      textarea.textarea {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html">Home</a>
    <a href="#" id="back-btn">목록으로</a>
  </nav>

  <div class="container">
    <article id="post" class="card">
      <h2 id="post-title">제목 로딩 중...</h2>
      <p id="post-content">내용 로딩 중...</p>
      <p id="participant-count">0/0 참여 중</p>
      <div style="margin-top:1rem; display: flex; gap: 0.5rem;">
        <button id="participate" class="btn">참여</button>
        <button id="edit" class="btn btn-outline">수정</button>
        <button id="delete" class="btn btn-outline" style="color:red;border-color:red;">삭제</button>
      </div>
    </article>

    <section class="card comment">
      <h3>댓글</h3>
      <div id="comment-list" class="comment-list">
        <!-- 댓글 리스트 -->
      </div>
      <form id="comment-form">
        <textarea id="comment-input" class="textarea" placeholder="댓글 작성" required></textarea><br/>
        <button type="submit" class="btn">댓글 달기</button>
      </form>
    </section>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const postId = params.get('id');
    const category = params.get('category');

    const postTitleEl = document.getElementById('post-title');
    const postContentEl = document.getElementById('post-content');
    const commentListEl = document.getElementById('comment-list');
    const participantCountEl = document.getElementById('participant-count');

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    function loadPost() {
      fetch(`/api/posts/${postId}`)
        .then(res => {
          if (!res.ok) throw new Error('글을 불러오는 중 오류가 발생했습니다.');
          return res.json();
        })
        .then(post => {
          postTitleEl.textContent = escapeHtml(post.title);
          postContentEl.textContent = escapeHtml(post.content);
          participantCountEl.textContent = `${post.participants?.length || 0}/${post.maxParticipants || 0} 참여 중`;
          renderComments(post.comments || []);
        })
        .catch(err => {
          postTitleEl.textContent = '글을 불러오는 중 오류가 발생했습니다.';
          postContentEl.textContent = '';
          console.error(err);
        });
    }

    function renderComments(comments) {
      if (comments.length === 0) {
        commentListEl.innerHTML = '<p>댓글이 없습니다.</p>';
        return;
      }
      commentListEl.innerHTML = comments.map(c =>
        `<div class="comment-item"><strong>${escapeHtml(c.author || '익명')}</strong> : ${escapeHtml(c.text)}</div>`
      ).join('');
    }

    const commentForm = document.getElementById('comment-form');
    commentForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = document.getElementById('comment-input').value.trim();
      if (!text) return alert('댓글 내용을 입력하세요.');

      fetch(`/api/posts/${postId}/comments`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text, author: '익명' })
      })
      .then(res => {
        if (res.ok) return res.json();
        else throw new Error('댓글 작성 실패');
      })
      .then(updatedPost => {
        document.getElementById('comment-input').value = '';
        renderComments(updatedPost.comments || []);
      })
      .catch(err => {
        alert(err.message);
        console.error(err);
      });
    });

    document.getElementById('delete').addEventListener('click', () => {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      fetch(`/api/posts/${postId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            alert('삭제되었습니다.');
            window.location.href = `board.html?category=${encodeURIComponent(category || '')}`;
          } else {
            alert('삭제 실패');
          }
        })
        .catch(err => {
          alert('서버 오류');
          console.error(err);
        });
    });

    document.getElementById('edit').addEventListener('click', () => {
      window.location.href = `write.html?id=${postId}&category=${encodeURIComponent(category || '')}`;
    });

    document.getElementById('participate').addEventListener('click', () => {
      fetch(`/api/posts/${postId}/participate`, { method: 'POST' })
        .then(res => {
          if (res.ok) return res.json();
          else throw new Error('참여 실패');
        })
        .then(updatedPost => {
          participantCountEl.textContent = `${updatedPost.participants.length}/${updatedPost.maxParticipants} 참여 중`;
        })
        .catch(err => {
          alert(err.message);
          console.error(err);
        });
    });

    document.getElementById('back-btn').addEventListener('click', (e) => {
      e.preventDefault();
      window.history.back();
    });

    loadPost();
  </script>
</body>
</html>
